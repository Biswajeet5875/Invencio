<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cart Page - Invencio</title>
  <link rel="stylesheet" href="css/cart.css" />
</head>

<body>
  <!-- Header Section -->
  <header class="header">
    <div class="logo">INVENCIO</div>
    <div class="search-bar">
      <input type="text" placeholder="Search your item" />
      <button>Search</button>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main-content">
    <div class="cart-container">
      <!-- Cart Items -->
      <div class="cart-items">
        <h2>Shopping Cart</h2>
        <div id="cart-items-container">
          <!-- Cart items will be dynamically added here -->
        </div>
      </div>

      <!-- Cart Summary -->
      <div class="cart-summary">
        <h2>Order Summary</h2>
        <div class="summary-details">
          <p>Subtotal (<span id="cart-item-count">0</span> items):</p>
          <p class="subtotal" id="cart-subtotal">₹0</p>
        </div>
        <button class="checkout-btn" onclick="checkout()">Proceed to Checkout</button>
      </div>
    </div>
  </main>

  <script>
    // Function to load cart items from local storage
    function loadCart() {
      const cart = JSON.parse(localStorage.getItem("cart")) || [];
      const cartItemsContainer = document.getElementById("cart-items-container");
      const cartItemCount = document.getElementById("cart-item-count");
      const cartSubtotal = document.getElementById("cart-subtotal");

      // Clear current content
      cartItemsContainer.innerHTML = "";

      let subtotal = 0;
      let itemCount = 0;

      // Populate cart items
      cart.forEach((item, index) => {
        const itemElement = document.createElement("div");
        itemElement.className = "cart-item";
        itemElement.innerHTML = `
          <img src="images/product.jpg" alt="Product Image" />
          <div class="item-details">
            <h3>${item.stockName}</h3>
            <p class="stock">In Stock</p>
            <div class="item-actions">
              <button onclick="removeCartItem(${index})">Remove</button>
            </div>
          </div>
          <div class="item-quantity">
  <select onchange="updateQuantity(${index}, this.value)">
    ${[...Array(1500).keys()].map(qty => qty + 1).concat(item.quantity > 5 ? item.quantity : []).map(
          qty => `<option value="${qty}" ${qty === item.quantity ? "selected" : ""}>${qty}</option>`
        ).join("")}
  </select>
  <p>₹${item.price}</p>
</div>
        `;

        cartItemsContainer.appendChild(itemElement);

        // Update subtotal and item count
        subtotal += item.price * item.quantity;
        itemCount += item.quantity;
      });

      // Update cart summary
      cartItemCount.textContent = itemCount;
      cartSubtotal.textContent = `₹${subtotal}`;
    }

    // Function to remove a cart item
    function removeCartItem(index) {
      const cart = JSON.parse(localStorage.getItem("cart")) || [];
      cart.splice(index, 1); // Remove item from cart
      localStorage.setItem("cart", JSON.stringify(cart));
      loadCart(); // Reload cart
    }

    // Function to update item quantity
    function updateQuantity(index, quantity) {
      const cart = JSON.parse(localStorage.getItem("cart")) || [];
      cart[index].quantity = parseInt(quantity);
      localStorage.setItem("cart", JSON.stringify(cart));
      loadCart(); // Reload cart
    }

    // Function to handle checkout
    async function checkout() {
      const cart = JSON.parse(localStorage.getItem("cart")) || [];

      if (cart.length === 0) {
        alert("Your cart is empty!");
        return;
      }

      try {
        const response = await fetch("http://localhost:8081/update-stock-quantity", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(cart), // Sending cart data to backend
        });

        if (response.ok) {
          alert("Checkout completed successfully!");
          localStorage.removeItem("cart"); // Clear the cart
          loadCart();
          window.location.href = "http://localhost:8081/viewstock";
          // Reload the cart
        } else {
          const errorMessage = await response.text(); // Get the error message from the response
          alert(`Failed to update stock: ${errorMessage}`);
        }
      } catch (error) {
        console.error("Error during checkout:", error);
        alert("An unexpected error occurred. Please try again later.");
      }
    }



    // Load cart items when the page loads
    window.onload = loadCart;
  </script>
</body>

</html>